<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Security Test - Fix My Medical Bill</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #2d3748; }
    h2 { color: #4a5568; font-size: 18px; margin-top: 0; }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover { background: #2563eb; }
    .result {
      margin-top: 15px;
      padding: 15px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 13px;
      white-space: pre-wrap;
    }
    .success { background: #d1fae5; color: #065f46; }
    .error { background: #fee2e2; color: #991b1b; }
    .info { background: #dbeafe; color: #1e40af; }
    .warning { background: #fef3c7; color: #92400e; }
  </style>
</head>
<body>
  <h1>ğŸ”’ Security Test Dashboard</h1>
  <p>ë¹ ë¥¸ ë³´ì•ˆ ê¸°ëŠ¥ ê²€ì¦ ë„êµ¬</p>

  <!-- Test 1: reCAPTCHA -->
  <div class="test-section">
    <h2>1ï¸âƒ£ reCAPTCHA Token ìƒì„± í…ŒìŠ¤íŠ¸</h2>
    <button onclick="testRecaptcha()">reCAPTCHA í…ŒìŠ¤íŠ¸</button>
    <div id="recaptcha-result"></div>
  </div>

  <!-- Test 2: API Without Token -->
  <div class="test-section">
    <h2>2ï¸âƒ£ ë³´ì•ˆ: Token ì—†ì´ API í˜¸ì¶œ (ì°¨ë‹¨ë˜ì–´ì•¼ í•¨)</h2>
    <button onclick="testWithoutToken()">Token ì—†ì´ í˜¸ì¶œ</button>
    <div id="no-token-result"></div>
  </div>

  <!-- Test 3: Rate Limiting -->
  <div class="test-section">
    <h2>3ï¸âƒ£ Rate Limiting í…ŒìŠ¤íŠ¸ (3ì´ˆ ë‚´ 2ë²ˆ â†’ ì°¨ë‹¨)</h2>
    <button onclick="testRateLimit()">Rate Limit í…ŒìŠ¤íŠ¸</button>
    <div id="rate-limit-result"></div>
  </div>

  <!-- Test 4: File Size -->
  <div class="test-section">
    <h2>4ï¸âƒ£ íŒŒì¼ í¬ê¸° ì œí•œ í…ŒìŠ¤íŠ¸</h2>
    <button onclick="testFileSize()">ëŒ€ìš©ëŸ‰ íŒŒì¼ ì°¨ë‹¨ í™•ì¸</button>
    <div id="file-size-result"></div>
  </div>

  <!-- Test 5: CORS -->
  <div class="test-section">
    <h2>5ï¸âƒ£ CORS ì œí•œ í™•ì¸</h2>
    <button onclick="testCORS()">CORS í…ŒìŠ¤íŠ¸</button>
    <div id="cors-result"></div>
  </div>

  <script src="https://www.google.com/recaptcha/api.js?render=6Lcw_HIsAAAAADUYy4ueF4DQ0D5Dr_uqOXF2xmEJ"></script>
  <script>
    function showResult(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.innerHTML = `<div class="result ${type}">${message}</div>`;
    }

    // Test 1: reCAPTCHA
    async function testRecaptcha() {
      showResult('recaptcha-result', 'â³ Testing...', 'info');
      try {
        if (typeof grecaptcha === 'undefined') {
          showResult('recaptcha-result', 'âŒ grecaptcha not loaded', 'error');
          return;
        }

        const token = await new Promise((resolve, reject) => {
          grecaptcha.ready(() => {
            grecaptcha.execute('6Lcw_HIsAAAAADUYy4ueF4DQ0D5Dr_uqOXF2xmEJ', { action: 'test' })
              .then(resolve)
              .catch(reject);
          });
        });

        showResult('recaptcha-result', 
          `âœ… reCAPTCHA Token ìƒì„± ì„±ê³µ!\n\nToken: ${token.substring(0, 50)}...\nLength: ${token.length} chars\n\nì´ í† í°ì€ ë°±ì—”ë“œì—ì„œ ê²€ì¦ë©ë‹ˆë‹¤.`,
          'success'
        );
      } catch (error) {
        showResult('recaptcha-result', `âŒ Error: ${error.message}`, 'error');
      }
    }

    // Test 2: API Without Token
    async function testWithoutToken() {
      showResult('no-token-result', 'â³ Testing...', 'info');
      try {
        const response = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: "test" }] }],
            generationConfig: {},
            action: 'test'
            // recaptchaToken ì˜ë„ì ìœ¼ë¡œ ëˆ„ë½
          })
        });

        const data = await response.json();
        
        if (response.status === 400 && data.error === 'Missing reCAPTCHA token') {
          showResult('no-token-result', 
            `âœ… ë³´ì•ˆ ì •ìƒ ì‘ë™!\n\nStatus: ${response.status}\nError: ${data.error}\nMessage: ${data.message}\n\nToken ì—†ëŠ” ìš”ì²­ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.`,
            'success'
          );
        } else {
          showResult('no-token-result', 
            `âš ï¸ ì˜ˆìƒê³¼ ë‹¤ë¥¸ ì‘ë‹µ:\n\nStatus: ${response.status}\nData: ${JSON.stringify(data, null, 2)}`,
            'warning'
          );
        }
      } catch (error) {
        showResult('no-token-result', `âŒ Network Error: ${error.message}`, 'error');
      }
    }

    // Test 3: Rate Limiting
    async function testRateLimit() {
      showResult('rate-limit-result', 'â³ Testing... (2ë²ˆ ì—°ì† ìš”ì²­)', 'info');
      try {
        // Get reCAPTCHA token first
        const token = await new Promise((resolve) => {
          grecaptcha.ready(() => {
            grecaptcha.execute('6Lcw_HIsAAAAADUYy4ueF4DQ0D5Dr_uqOXF2xmEJ', { action: 'test' })
              .then(resolve);
          });
        });

        // First request
        const req1 = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: "test 1" }] }],
            recaptchaToken: token,
            action: 'test'
          })
        });
        const data1 = await req1.json();
        const status1 = req1.status;

        // Second request (immediately)
        const req2 = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: "test 2" }] }],
            recaptchaToken: token,
            action: 'test'
          })
        });
        const data2 = await req2.json();
        const status2 = req2.status;

        if (status2 === 429) {
          showResult('rate-limit-result', 
            `âœ… Rate Limiting ì •ìƒ ì‘ë™!\n\nRequest 1: ${status1} (${data1.error || 'Success'})\nRequest 2: ${status2} (${data2.error})\n\nWait Time: ${data2.waitTime} second(s)\nMessage: ${data2.message}`,
            'success'
          );
        } else {
          showResult('rate-limit-result', 
            `âš ï¸ Rate limitì´ íŠ¸ë¦¬ê±°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\nRequest 1: ${status1}\nRequest 2: ${status2}\n\nâ€» ì„œë²„ë¦¬ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ê°€ ë¶„ë¦¬ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì‹¤ì œ ì‚¬ìš©ì í…ŒìŠ¤íŠ¸ë¡œ 3ì´ˆ ë‚´ ë‹¤ì‹œ ì—…ë¡œë“œ ì‹œë„í•´ë³´ì„¸ìš”.`,
            'warning'
          );
        }
      } catch (error) {
        showResult('rate-limit-result', `âŒ Error: ${error.message}`, 'error');
      }
    }

    // Test 4: File Size
    async function testFileSize() {
      showResult('file-size-result', 'â³ Testing...', 'info');
      try {
        const largeData = 'x'.repeat(11 * 1024 * 1024); // 11MB of data
        
        const response = await fetch('/api/generate', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Content-Length': (11 * 1024 * 1024).toString()
          },
          body: JSON.stringify({
            contents: [{ parts: [{ text: largeData }] }],
            recaptchaToken: 'test',
            action: 'test'
          })
        });

        const data = await response.json();
        
        if (response.status === 413) {
          showResult('file-size-result', 
            `âœ… íŒŒì¼ í¬ê¸° ì œí•œ ì •ìƒ ì‘ë™!\n\nStatus: ${response.status}\nError: ${data.error}\nMessage: ${data.message}\nMax Size: ${data.maxSize}\n\n10MB ì´ˆê³¼ íŒŒì¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.`,
            'success'
          );
        } else {
          showResult('file-size-result', 
            `âš ï¸ ì˜ˆìƒê³¼ ë‹¤ë¥¸ ì‘ë‹µ:\n\nStatus: ${response.status}\nData: ${JSON.stringify(data, null, 2)}`,
            'warning'
          );
        }
      } catch (error) {
        showResult('file-size-result', `âŒ Error: ${error.message}`, 'error');
      }
    }

    // Test 5: CORS
    async function testCORS() {
      showResult('cors-result', 'â³ Testing...', 'info');
      
      const origin = window.location.origin;
      const allowed = [
        'https://fixmymedicalbill.com',
        'https://www.fixmymedicalbill.com',
        'https://fix-my-medicalbill.vercel.app',
        'http://localhost:5173',
        'http://localhost:5174'
      ];

      if (allowed.includes(origin)) {
        showResult('cors-result', 
          `âœ… CORS ì„¤ì • í™•ì¸\n\ní˜„ì¬ ë„ë©”ì¸: ${origin}\ní—ˆìš©ëœ ë„ë©”ì¸ ë¦¬ìŠ¤íŠ¸ì— í¬í•¨ë©ë‹ˆë‹¤.\n\ní—ˆìš© ë„ë©”ì¸:\n${allowed.join('\n')}\n\nAPI ìš”ì²­ì´ ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.`,
          'success'
        );
      } else {
        showResult('cors-result', 
          `âš ï¸ í˜„ì¬ ë„ë©”ì¸ì´ í—ˆìš© ë¦¬ìŠ¤íŠ¸ì— ì—†ìŠµë‹ˆë‹¤.\n\ní˜„ì¬: ${origin}\n\ní—ˆìš© ë„ë©”ì¸:\n${allowed.join('\n')}\n\nAPI ìš”ì²­ì´ ì°¨ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
          'warning'
        );
      }
    }
  </script>
</body>
</html>
